name: CI/CD

on:
  push:
    branches: [main]
    tags:
      - 'beta-*'
      - 'stable-*'
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CWM_GITHUB_REPO: taulfsime/cool-window-manager

jobs:
  test:
    name: Test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run tests
        run: cargo test --all-features
      
      - name: Check formatting
        run: cargo fmt -- --check
      
      - name: Run clippy
        run: cargo clippy -- -D warnings

  build:
    name: Build
    needs: [test]
    runs-on: macos-latest
    if: github.event_name == 'push'
    
    strategy:
      matrix:
        target:
          - aarch64-apple-darwin
          - x86_64-apple-darwin
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Determine release channel
        id: channel
        run: |
          if [[ "${{ github.ref }}" == refs/tags/beta-* ]]; then
            CHANNEL="beta"
            TAG="${{ github.ref_name }}"
          elif [[ "${{ github.ref }}" == refs/tags/stable-* ]]; then
            CHANNEL="stable"
            TAG="${{ github.ref_name }}"
          else
            CHANNEL="dev"
            TAG="dev-$(git rev-parse --short HEAD)"
          fi
          
          echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Building for channel: $CHANNEL"
      
      - name: Validate tag format
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG="${{ github.ref_name }}"
          
          if [[ "$TAG" =~ ^(beta|stable)-([a-f0-9]{8})$ ]]; then
            CHANNEL="${BASH_REMATCH[1]}"
            TAG_COMMIT="${BASH_REMATCH[2]}"
            CURRENT_COMMIT=$(git rev-parse --short HEAD)
            
            if [ "$TAG_COMMIT" != "$CURRENT_COMMIT" ]; then
              echo "Error: Tag commit ($TAG_COMMIT) doesn't match current HEAD ($CURRENT_COMMIT)"
              exit 1
            fi
            
            echo "âœ“ Valid ${CHANNEL} tag for commit ${TAG_COMMIT}"
          else
            echo "Error: Invalid tag format: $TAG"
            echo "Expected format: beta-{8-char-hash} or stable-{8-char-hash}"
            exit 1
          fi
      
      - name: Build release binary
        env:
          RELEASE_CHANNEL: ${{ steps.channel.outputs.channel }}
        run: |
          cargo build --release --target ${{ matrix.target }}
          strip target/${{ matrix.target }}/release/cwm
      
      - name: Create archive
        run: |
          COMMIT=$(git rev-parse --short HEAD)
          DATE=$(date +%Y%m%d)
          CHANNEL=${{ steps.channel.outputs.channel }}
          ARCH=${{ matrix.target }}
          
          FILENAME="cwm-${CHANNEL}-${COMMIT}-${DATE}-${ARCH}.tar.gz"
          
          # create staging directory with binary and man page
          mkdir -p staging
          cp target/${{ matrix.target }}/release/cwm staging/
          
          # find man page in OUT_DIR (generated by build.rs)
          MAN_PAGE=$(find target/${{ matrix.target }}/release/build -name "cwm.1" -type f 2>/dev/null | head -1)
          if [ -n "$MAN_PAGE" ] && [ -s "$MAN_PAGE" ]; then
            cp "$MAN_PAGE" staging/
            echo "Included man page from: $MAN_PAGE"
          else
            echo "Warning: Man page not found or empty"
          fi
          
          # create archive
          tar czf "${FILENAME}" -C staging .
          
          shasum -a 256 "${FILENAME}" > "${FILENAME}.sha256"
          
          echo "ARTIFACT_NAME=${FILENAME}" >> $GITHUB_ENV
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            ${{ env.ARTIFACT_NAME }}
            ${{ env.ARTIFACT_NAME }}.sha256

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: Determine release properties
        id: release
        run: |
          COMMIT=$(git rev-parse --short HEAD)
          DATE=$(date +%Y%m%d)
          
          # calculate CalVer from commit timestamp (YYYY.M.D format)
          TIMESTAMP=$(git log -1 --format=%ct)
          CALVER=$(date -d "@${TIMESTAMP}" +%Y.%-m.%-d 2>/dev/null || date -r "${TIMESTAMP}" +%Y.%-m.%-d)
          
          if [[ "${{ github.ref }}" == refs/tags/beta-* ]]; then
            CHANNEL="beta"
            TAG="${{ github.ref_name }}"
            SEMVER="${CALVER}+beta.${COMMIT}"
            NAME="Beta Release ${SEMVER}"
            PRERELEASE="true"
          elif [[ "${{ github.ref }}" == refs/tags/stable-* ]]; then
            CHANNEL="stable"
            TAG="${{ github.ref_name }}"
            SEMVER="${CALVER}+${COMMIT}"
            NAME="Stable Release ${SEMVER}"
            PRERELEASE="false"
          else
            CHANNEL="dev"
            TAG="dev-${COMMIT}"
            SEMVER="${CALVER}+dev.${COMMIT}"
            NAME="Development Build ${SEMVER}"
            PRERELEASE="true"
          fi
          
          echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
          echo "semver=$SEMVER" >> $GITHUB_OUTPUT
          echo "calver=$CALVER" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
      
      - name: Generate release notes
        id: notes
        run: |
          CHANNEL="${{ steps.release.outputs.channel }}"
          
          # get commits since last release of same channel
          if [[ "$CHANNEL" == "dev" ]]; then
            LAST_TAG=$(git tag -l 'dev-*' --sort=-version:refname | head -n 2 | tail -n 1)
          elif [[ "$CHANNEL" == "beta" ]]; then
            LAST_TAG=$(git tag -l 'beta-*' --sort=-version:refname | head -n 2 | tail -n 1)
          else
            LAST_TAG=$(git tag -l 'stable-*' --sort=-version:refname | head -n 2 | tail -n 1)
          fi
          
          if [ -n "$LAST_TAG" ]; then
            CHANNEL_COMMITS=$(git log --oneline ${LAST_TAG}..HEAD)
            CHANNEL_COUNT=$(git rev-list --count ${LAST_TAG}..HEAD)
          else
            CHANNEL_COMMITS=$(git log --oneline -20)
            CHANNEL_COUNT=20
          fi
          
          # get all commits since last stable for context
          LAST_STABLE=$(git tag -l 'stable-*' --sort=-version:refname | head -n 1)
          if [ -n "$LAST_STABLE" ] && [ "$CHANNEL" != "stable" ]; then
            ALL_COMMITS=$(git log --oneline ${LAST_STABLE}..HEAD)
            ALL_COUNT=$(git rev-list --count ${LAST_STABLE}..HEAD)
            DIFF_URL="https://github.com/${{ github.repository }}/compare/${LAST_STABLE}...HEAD"
          else
            ALL_COMMITS=""
            ALL_COUNT=0
            if [ -n "$LAST_TAG" ]; then
              DIFF_URL="https://github.com/${{ github.repository }}/compare/${LAST_TAG}...HEAD"
            else
              DIFF_URL=""
            fi
          fi
          
          cat > RELEASE_NOTES.md << ENDOFNOTES
          ## ${{ steps.release.outputs.channel }} Release
          
          **Version:** \`${{ steps.release.outputs.semver }}\`
          **Commit:** \`${{ github.sha }}\`
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ### Changes in this release
          
          \`\`\`
          ${CHANNEL_COMMITS}
          \`\`\`
          
          ENDOFNOTES
          
          if [ -n "$ALL_COMMITS" ] && [ "$CHANNEL" != "stable" ]; then
            cat >> RELEASE_NOTES.md << 'ENDOFNOTES'
          <details>
          <summary>All changes since last stable (${ALL_COUNT} commits)</summary>
          
          ```
          ${ALL_COMMITS}
          ```
          </details>
          
          ENDOFNOTES
          fi
          
          if [ -n "$DIFF_URL" ]; then
            echo "[View full diff](${DIFF_URL})" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
          fi
          
          if [[ "${{ steps.release.outputs.channel }}" == "stable" ]]; then
            cat >> RELEASE_NOTES.md << 'ENDOFNOTES'
          ### Installation
          
          ```bash
          # Homebrew (recommended)
          brew tap taulfsime/cwm https://github.com/taulfsime/cool-window-manager
          brew install cwm
          
          # Cargo (crates.io)
          cargo install cwm
          
          # Quick install script
          curl -fsSL https://raw.githubusercontent.com/taulfsime/cool-window-manager/main/install.sh | sh
          ```
          
          ENDOFNOTES
          else
            cat >> RELEASE_NOTES.md << ENDOFNOTES
          ### Installation
          
          \`\`\`bash
          # Quick install
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | sh
          
          # Install specific channel
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | sh -s -- --${{ steps.release.outputs.channel }}
          \`\`\`
          
          ENDOFNOTES
          fi
          
          cat >> RELEASE_NOTES.md << 'ENDOFNOTES'
          ### Files
          
          - `cwm-*-aarch64-apple-darwin.tar.gz` - Apple Silicon (M1/M2/M3)
          - `cwm-*-x86_64-apple-darwin.tar.gz` - Intel Macs
          - `*.sha256` - Checksums for verification
          ENDOFNOTES
      
      - name: Flatten artifacts
        run: |
          mkdir -p release_files
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.sha256" \) -exec cp {} release_files/ \;
          ls -la release_files/
      
      - name: Create or update release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release.outputs.tag }}
          name: ${{ steps.release.outputs.name }}
          body_path: RELEASE_NOTES.md
          prerelease: ${{ steps.release.outputs.prerelease }}
          files: release_files/*
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update Homebrew formula
        if: steps.release.outputs.channel == 'stable'
        run: |
          COMMIT="${{ steps.release.outputs.commit }}"
          DATE="${{ steps.release.outputs.date }}"
          SEMVER="${{ steps.release.outputs.semver }}"
          
          # get checksums from release files
          ARM64_SHA=$(cat release_files/cwm-stable-${COMMIT}-${DATE}-aarch64-apple-darwin.tar.gz.sha256 | awk '{print $1}')
          X86_64_SHA=$(cat release_files/cwm-stable-${COMMIT}-${DATE}-x86_64-apple-darwin.tar.gz.sha256 | awk '{print $1}')
          
          # update homebrew formula
          sed -i "s|version \".*\"|version \"${SEMVER}\"|" homebrew/cwm.rb
          sed -i "s|/stable-[a-f0-9]\{8\}/|/stable-${COMMIT}/|g" homebrew/cwm.rb
          sed -i "s|cwm-stable-[a-f0-9]\{8\}-[0-9]\{8\}-aarch64|cwm-stable-${COMMIT}-${DATE}-aarch64|g" homebrew/cwm.rb
          sed -i "s|cwm-stable-[a-f0-9]\{8\}-[0-9]\{8\}-x86_64|cwm-stable-${COMMIT}-${DATE}-x86_64|g" homebrew/cwm.rb
          sed -i "s|sha256 \"PLACEHOLDER_ARM64_SHA256\"|sha256 \"${ARM64_SHA}\"|" homebrew/cwm.rb
          sed -i "s|sha256 \"PLACEHOLDER_X86_64_SHA256\"|sha256 \"${X86_64_SHA}\"|" homebrew/cwm.rb
          # also update existing sha256 values
          sed -i "s|sha256 \"[a-f0-9]\{64\}\" # arm64|sha256 \"${ARM64_SHA}\" # arm64|" homebrew/cwm.rb
          sed -i "s|sha256 \"[a-f0-9]\{64\}\" # x86_64|sha256 \"${X86_64_SHA}\" # x86_64|" homebrew/cwm.rb
          
          echo "Updated homebrew/cwm.rb:"
          cat homebrew/cwm.rb
      
      - name: Commit Homebrew formula update
        if: steps.release.outputs.channel == 'stable'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add homebrew/cwm.rb
          git commit -m "chore: update homebrew formula to ${{ steps.release.outputs.semver }}" || echo "No changes to commit"
          git push origin HEAD:main
      
      - name: Cleanup old dev releases
        if: steps.release.outputs.channel == 'dev'
        uses: actions/github-script@v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const devReleases = releases.data
              .filter(r => r.tag_name.startsWith('dev-'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // keep last 3 dev builds
            for (let i = 3; i < devReleases.length; i++) {
              console.log(`Deleting old dev release: ${devReleases[i].tag_name}`);
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: devReleases[i].id
              });
              
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `tags/${devReleases[i].tag_name}`
                });
              } catch (e) {
                console.log(`Could not delete tag: ${e.message}`);
              }
            }

  publish-crates:
    name: Publish to crates.io
    needs: [release]
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/stable-')
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Verify package
        env:
          RELEASE_CHANNEL: stable
        run: cargo publish --dry-run
      
      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          RELEASE_CHANNEL: stable
        run: cargo publish

  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
